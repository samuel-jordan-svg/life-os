<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sam's Life OS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0d0d12;--card:#1a1a24;--purple:#8b5cf6;--cyan:#06b6d4;--green:#10b981;--orange:#f59e0b;--red:#ef4444;
--text:#fff;--text2:#9ca3af;--border:rgba(255,255,255,0.08)
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:100px}
.nav{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,#13131a,#0d0d12);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:12px 8px 25px;z-index:100;backdrop-filter:blur(20px)}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--text2);font-size:10px;cursor:pointer}
.nav-item.active{color:var(--purple)}
.nav-item i{font-size:20px}
.page{display:none;padding-bottom:80px;min-height:calc(100vh - 80px)}
.page.active{display:block}
.c{max-width:420px;margin:0 auto;padding:20px}
.h{background:linear-gradient(135deg,rgba(139,92,246,0.25),rgba(6,182,212,0.15));border-radius:28px;padding:32px 24px;margin-bottom:20px;border:1px solid var(--border)}
.g{font-size:14px;color:var(--text2);font-weight:500}
.t{font-size:48px;font-weight:700;color:#fff;margin-top:8px}
.d{font-size:13px;color:var(--text2);margin-top:4px}
.s{display:flex;justify-content:space-between;margin-top:24px;flex-wrap:wrap;gap:8px}
.si{text-align:center;flex:1;min-width:80px}
.si:not(:last-child){border-right:1px solid var(--border)}
.sv{font-size:18px;font-weight:700}
.sl{font-size:9px;color:var(--text2);text-transform:uppercase;margin-top:4px}
.sv.green{color:var(--green)}
.sv.cyan{color:var(--cyan)}
.sv.orange{color:var(--orange)}
.sv.red{color:var(--red)}
.sec{background:linear-gradient(145deg,var(--card),#13131a);border-radius:24px;padding:20px;margin-bottom:16px;border:1px solid var(--border)}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.slft{display:flex;align-items:center;gap:12px}
.si2{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(6,182,212,0.15));border:1px solid rgba(139,92,246,0.2)}
.st{font-size:15px;font-weight:600}
.tag{display:inline-block;padding:3px 8px;background:rgba(139,92,246,0.15);color:var(--purple);border-radius:6px;font-size:9px;font-weight:600;text-transform:uppercase}
.tag.green{background:rgba(16,185,129,0.15);color:var(--green)}
.tag.orange{background:rgba(245,158,11,0.15);color:var(--orange)}
.tag.cyan{background:rgba(6,182,212,0.15);color:var(--cyan)}
.tag.red{background:rgba(239,68,68,0.15);color:var(--red)}
.hi{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:8px;cursor:pointer}
.hc{width:26px;height:26px;border-radius:6px;border:2px solid var(--orange);display:flex;align-items:center;justify-content:center;flex-shrink:0;background:transparent}
.hc.checked{background:var(--green);border-color:var(--green)}
.hc.evening{border-color:var(--cyan)}
.hc.evening.checked{background:linear-gradient(135deg,var(--cyan),#22d3ee);border-color:var(--cyan)}
.hc.checked::after{content:'âœ“';color:white;font-size:12px;font-weight:bold}
.hn{flex:1}
.hn2{font-size:13px;font-weight:500}
.hd{font-size:11px;color:var(--text2);margin-top:2px}
.debt-item{background:rgba(255,255,255,0.03);border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid var(--border)}
.debt-item:hover{border-color:var(--purple)}
.debt-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.debt-name{font-size:14px;font-weight:600}
.debt-bal{font-size:18px;font-weight:700}
.debt-bal.active{color:var(--orange)}
.debt-bal.paid{color:var(--green)}
.debt-meta{font-size:11px;color:var(--text2)}
.debt-btns{display:flex;gap:8px;margin-top:10px}
.debt-btn{flex:1;padding:8px;border-radius:8px;border:none;font-size:11px;font-weight:600;cursor:pointer}
.debt-btn.pay{background:linear-gradient(135deg,var(--purple),var(--cyan));color:#fff}
.debt-btn.edit{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--text2)}
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.hist-item:last-child{border-bottom:none}
.hist-info{font-size:12px}
.hist-amt{color:var(--green);font-weight:600}
.hist-date{font-size:11px;color:var(--text2)}
.bill-item{display:flex;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:6px;cursor:pointer}
.bill-name{font-size:13px}
.bill-amt{font-size:13px;font-weight:600}
.bill-paid{background:rgba(16,185,129,0.15);color:var(--green)}
input,select{width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:14px;margin-bottom:10px}
.btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--purple),var(--cyan));border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;margin-top:10px}
.quick-nav{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.nav-btn{background:var(--card);border-radius:16px;padding:16px 8px;text-align:center;cursor:pointer;transition:all 0.2s;border:1px solid var(--border);display:flex;flex-direction:column;align-items:center;gap:6px}
.nav-btn:active{transform:scale(0.95);background:rgba(139,92,246,0.2)}
.nav-btn span{font-size:10px;color:var(--text2);font-weight:500}
.nav-btn:hover{border-color:var(--purple)}
.nav-btn span:first-child{font-size:24px}
@media(max-width:767px){.c{padding:16px}.h{padding:24px 20px;border-radius:20px}.t{font-size:40px}}
</style>
</head>
<body>

<!-- Dashboard -->
<div id="page-dashboard" class="page active">
<div class="c">
<div class="h">
<div class="g">SAM'S LIFE OS</div>
<div class="t" id="clock">--:--</div>
<div class="d" id="dayInfo">Loading...</div>
<div class="s">
<div class="si"><div class="sv" id="yearPct">--%</div><div class="sl">YEAR</div></div>
<div class="si"><div class="sv cyan" id="daysTo">--</div><div class="sl">DAYS</div></div>
<div class="si"><div class="sv green" id="debt">Â£15.4k</div><div class="sl">DEBT</div></div>
</div>
</div>

<!-- Quick Nav -->
<div class="quick-nav">
<div class="nav-btn" onclick="go('money')"><span>ğŸ’°</span><span>Money</span></div>
<div class="nav-btn" onclick="go('health')"><span>â¤ï¸</span><span>Health</span></div>
<div class="nav-btn" onclick="go('tasks')"><span>ğŸ“‹</span><span>Tasks</span></div>
<div class="nav-btn" onclick="go('settings')"><span>âš™ï¸</span><span>Settings</span></div>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2" style="background:linear-gradient(135deg,rgba(245,158,11,0.4),rgba(251,191,36,0.3))">ğŸŒ…</div><div class="st">Morning</div></div><span class="tag orange" id="mornProg">0/6</span></div>
<div id="mornHabits"></div>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2" style="background:linear-gradient(135deg,rgba(6,182,212,0.4),rgba(34,211,238,0.3))">ğŸŒ™</div><div class="st">Evening</div></div><span class="tag cyan" id="eveProg">0/5</span></div>
<div id="eveHabits"></div>
</div>
</div>
</div>

<!-- Money -->
<div id="page-money" class="page">
<div class="c">
<div class="h">
<div class="g">FINANCIAL COMMAND CENTER</div>
<div class="t" id="clockM">--:--</div>
<div class="d" id="dayInfoM">Loading...</div>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2">ğŸ“Š</div><div class="st">Monthly Summary</div></div></div>
<div class="s" style="margin-bottom:0">
<div class="si"><div class="sv green">Â£1,872</div><div class="sl">INCOME</div></div>
<div class="si"><div class="sv red" id="fixedTotal">Â£0</div><div class="sl">PAID</div></div>
<div class="si"><div class="sv orange" id="totalDebt">Â£15,402</div><div class="sl">DEBT</div></div>
<div class="si"><div class="sv cyan" id="remaining">Â£1,872</div><div class="sl">AVAILABLE</div></div>
</div>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2">ğŸ“„</div><div class="st">Fixed Bills</div></div><span class="tag" id="billCount">0 paid</span></div>
<div id="billsList"></div>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2">ğŸ’³</div><div class="st">Debts</div></div><span class="tag red" id="debtCount">5 debts</span></div>
<div id="debtsList"></div>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2">âš¡</div><div class="st">Quick Payment</div></div></div>
<input type="number" id="payAmt" placeholder="Amount">
<select id="payDebt"><option value="">Select debt</option></select>
<button class="btn" onclick="quickPay()">Pay Now</button>
</div>

<!-- Todoist Due Today -->
<div class="section">
<div class="section-header"><div class="section-icon" style="background:var(--gradient-purple)">âœ…</div><div class="section-title">Due Today</div><span class="tag" id="todoist-count">0 tasks</span></div>
<div id="todoist-tasks" style="color:var(--text2);font-size:13px">Loading...</div>
<button class="btn" onclick="loadTodoist()" style="background:var(--cyan)">ğŸ”„ Refresh</button>
<div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Tap a task to complete it</div>
</div>

<div class="sec">
<div class="sh"><div class="slft"><div class="si2">ğŸ“œ</div><div class="st">Payment History</div></div><button class="tag" onclick="clearHist()">Clear</button></div>
<div id="histList" style="font-size:12px;color:var(--text2)">No payments</div>
</div>
</div>
</div>

<!-- Health -->
<div id="page-health" class="page">
<div class="c">
<div class="h"><div class="g">HEALTH</div><div class="t" id="clockH">--:--</div><div class="d" id="dayInfoH">Loading...</div></div>
<div class="sec"><div class="st">ğŸƒ Running 500km</div><div style="margin:12px 0;color:var(--text2)">0 / 500km</div><div style="height:8px;background:rgba(255,255,255,0.08);border-radius:6px"><div style="height:100%;width:0%;background:linear-gradient(90deg,var(--purple),var(--cyan));border-radius:6px"></div></div></div>
<div class="sec"><div class="st">ğŸ“š Reading 24 books</div><div style="margin:12px 0;color:var(--text2)">0 / 24</div><div style="height:8px;background:rgba(255,255,255,0.08);border-radius:6px"><div style="height:100%;width:0%;background:var(--orange);border-radius:6px"></div></div></div>
</div>
</div>

<!-- Tasks -->
<div id="page-tasks" class="page">
<div class="c"><div class="h"><div class="g">TASKS</div><div class="t" id="clockT">--:--</div><div class="d" id="dayInfoT">Loading...</div></div><div class="sec"><div class="st">ğŸ“‹ Todoist</div><p style="color:var(--text2);margin-top:12px">Connect Todoist</p></div></div>
</div>

<!-- Settings -->
<div id="page-settings" class="page">
<div class="c"><div class="h"><div class="g">SETTINGS</div><div class="t" id="clockS">--:--</div><div class="d" id="dayInfoS">Loading...</div></div><div class="sec"><div class="st">âš™ï¸ Data Backup</div>
<p style="color:var(--text2);margin-top:12px;margin-bottom:16px">Export before clearing cache!</p>
<button class="btn" onclick="exportData()" style="background:var(--green)">ğŸ“¥ Export Backup</button>
<button class="btn" onclick="importData()" style="background:var(--cyan)">ğŸ“¤ Import Backup</button>
</div>

<div class="sec"><div class="st">ğŸ”— Todoist API</div>
<p style="color:var(--text2);margin-top:12px;margin-bottom:16px">Get token from Todoist Settings â†’ Integrations</p>
<input type="password" id="todoist-token" placeholder="Paste API token here" onchange="saveTodoistToken()">
<button class="btn" onclick="loadTodoist()" style="background:var(--purple)">ğŸ“‹ Load Today's Tasks</button>
</div></div>
</div>

<!-- Nav -->
<nav class="nav">
<div class="nav-item active" onclick="go('dashboard',this)"><i class="fas fa-home"></i><span>Home</span></div>
<div class="nav-item" onclick="go('money',this)"><i class="fas fa-pound-sign"></i><span>Money</span></div>
<div class="nav-item" onclick="go('health',this)"><i class="fas fa-heart"></i><span>Health</span></div>
<div class="nav-item" onclick="go('tasks',this)"><i class="fas fa-tasks"></i><span>Tasks</span></div>
<div class="nav-item" onclick="go('settings',this)"><i class="fas fa-cog"></i><span>Settings</span></div>
</nav>

<script>
// Habits
const MORN=[{n:'â° Wake 6am',d:'Wake at 6am'},{n:'ğŸŒ³ Outside 10min',d:'Stand outside'},{n:'ğŸ’§ Water',d:'Big glass'},{n:'ğŸ§˜ Stretch',d:'Stretching'},{n:'â˜• Coffee',d:'1hr after wake'},{n:'âœï¸ Write',d:'Win+Thing+Obstacle'}];
const EVE=[{n:'ğŸ½ï¸ Meal 4hrs bed',d:'Final meal'},{n:'ğŸ“µ Screens off',d:'60min before bed'},{n:'ğŸ“– Read',d:'10min read'},{n:'â˜• No caffeine',d:'Avoid stimulants'},{n:'ğŸ’¡ Red lights',d:'Amber lights'}];

// Auto-reset habits for new day
function checkDayReset(){
  let today=new Date().toISOString().split('T')[0];
  let lastDate=localStorage.getItem('lifeOSlastDate');
  if(lastDate!==today){
    // New day - reset habits
    localStorage.setItem('morn','{}');
    localStorage.setItem('eve','{}');
    localStorage.setItem('lifeOSlastDate',today);
    console.log('Habits reset for '+today);
  }
}

// Fixed Bills
let bills=[
{id:'rent',n:'ğŸ  Rent (girlfriend)',a:500,m:500,p:false},
{id:'phone',n:'ğŸ“± Phone',a:48.09,m:48.09,p:false},
{id:'carIns',n:'ğŸš— Car Insurance',a:32.50,m:32.50,p:false},
{id:'sky',n:'ğŸ“º Sky',a:53.00,m:53.00,p:false},
{id:'life',n:'â¤ï¸ Life Insurance',a:4.99,m:4.99,p:false},
{id:'kia',n:'ğŸš— Kia Finance (PCP)',a:198.29,m:198.29,p:false}
];

// Debts
let debts=[
{id:'argos',n:'ğŸª Argos Card',b:320,min:51.10,apr:0,end:'2026-06-14',h:[]},
{id:'monzo',n:'ğŸ¦ Monzo IFL',b:40,min:40,apr:0,end:null,h:[]},
{id:'virgin',n:'ğŸ’³ Virgin Money',b:2555.23,min:51.10,apr:26.49,end:'2027-09-16',h:[]},
{id:'lendable',n:'ğŸ¦ Lendable',b:11876.71,min:264.25,apr:15.8,end:null,h:[]},
{id:'zopa',n:'ğŸ’³ Zopa Spend',b:0,min:0,apr:34.4,end:null,h:[]}
];

let history=[];

function go(page,el){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  let navIndex={'dashboard':0,'money':1,'health':2,'tasks':3,'settings':4}[page];
  document.querySelectorAll('.nav-item').forEach((x,i)=>{if(i===navIndex)x.classList.add('active')});
  updateClocks();
}

function loadAll(){
  let ld=localStorage.getItem('lifeOSdebts');
  if(ld)debts=JSON.parse(ld);
  let lb=localStorage.getItem('lifeOSbills');
  if(lb)bills=JSON.parse(lb);
  let lh=localStorage.getItem('lifeOShistory');
  if(lh)history=JSON.parse(lh);
  calcTotals();
}

function saveAll(){
  localStorage.setItem('lifeOSdebts',JSON.stringify(debts));
  localStorage.setItem('lifeOSbills',JSON.stringify(bills));
  localStorage.setItem('lifeOShistory',JSON.stringify(history));
  calcTotals();
}

function calcTotals(){
  let totDebt=debts.reduce((a,b)=>a+(b.paid?0:b.b),0);
  let totBill=bills.filter(b=>b.p).reduce((a,b)=>a+b.m,0);
  let today=new Date().toLocaleDateString('en-GB');
  let todayPayments=history.filter(h=>h.d===today).reduce((a,h)=>a+parseFloat(h.a),0);
  let inc=1872.44;
  let available=inc-totBill-todayPayments;
  document.getElementById('totalDebt').textContent='Â£'+totDebt.toLocaleString();
  document.getElementById('fixedTotal').textContent='Â£'+totBill.toFixed(2);
  document.getElementById('remaining').textContent='Â£'+available.toFixed(2);
  document.getElementById('debt').textContent=totDebt<10000?'Â£'+(totDebt/1000).toFixed(1)+'k':'Â£'+(totDebt/1000).toFixed(1)+'k';
  document.getElementById('billCount').textContent=bills.filter(b=>b.p).length+' paid';
  document.getElementById('debtCount').textContent=debts.filter(d=>!d.paid).length+' debts';
}

function renderHabits(){
  let ms=JSON.parse(localStorage.getItem('morn')||'{}'),es=JSON.parse(localStorage.getItem('eve')||'{}');
  let mc=MORN.reduce((a,x,i)=>a+(ms[i]?1:0),0),ec=EVE.reduce((a,x,i)=>a+(es[i]?1:0),0);
  document.getElementById('mornHabits').innerHTML=MORN.map((x,i)=>
    '<div class="hi" onclick="toggleM('+i+',this)"><div class="hc '+(ms[i]?'checked':'')+'"></div><div class="hn"><div class="hn2">'+x.n+'</div><div class="hd">'+x.d+'</div></div></div>').join('');
  document.getElementById('eveHabits').innerHTML=EVE.map((x,i)=>
    '<div class="hi" onclick="toggleE('+i+',this)"><div class="hc evening '+(es[i]?'checked':'')+'"></div><div class="hn"><div class="hn2">'+x.n+'</div><div class="hd">'+x.d+'</div></div></div>').join('');
  document.getElementById('mornProg').textContent=mc+'/6';
  document.getElementById('eveProg').textContent=ec+'/5';
}

function toggleM(i){
  let s=JSON.parse(localStorage.getItem('morn')||'{}');
  s[i]=!s[i];
  localStorage.setItem('morn',JSON.stringify(s));
  renderHabits();
}

function toggleE(i){
  let s=JSON.parse(localStorage.getItem('eve')||'{}');
  s[i]=!s[i];
  localStorage.setItem('eve',JSON.stringify(s));
  renderHabits();
}

function renderBills(){
  document.getElementById('billsList').innerHTML=bills.map(b=>
    '<div class="bill-item '+(b.p?'bill-paid':'')+'" onclick="toggleBill(\''+b.id+'\')"><span class="bill-name">'+b.n+'</span><span class="bill-amt">Â£'+b.m.toFixed(2)+'</span></div>'
  ).join('');
}

function toggleBill(id){
  let b=bills.find(x=>x.id===id);
  if(b){
    b.p=!b.p;
    saveAll();
    renderBills();
  }
}

function renderDebts(){
  let d=document.getElementById('debtsList');
  let s=document.getElementById('payDebt');
  d.innerHTML=debts.sort((a,b)=>(a.paid?1:0)-(b.paid?1:0)).map(x=>{
    let paid=x.paid;
    let bal=paid?'PAID':'Â£'+x.b.toLocaleString();
    let balClass=paid?'paid':'active';
    let end=x.end?'0% ends '+x.end:x.apr+'% APR';
    let last=x.h.length>0?'<div style="font-size:11px;color:var(--text2);margin-top:6px">Last: Â£'+x.h[x.h.length-1].a+'</div>':'';
    return '<div class="debt-item" onclick="showDebtOpts(\''+x.id+'\')"><div class="debt-row"><div><div class="debt-name">'+x.n+'</div><div class="debt-meta">'+end+' â€¢ Min: Â£'+x.min+'</div></div><div class="debt-bal '+balClass+'">'+bal+'</div></div>'+(paid?'':'<div class="debt-btns"><button class="debt-btn pay" onclick="event.stopPropagation();payMin(\''+x.id+'\')">Pay Min</button><button class="debt-btn pay" onclick="event.stopPropagation();payCustom(\''+x.id+'\')">Custom</button><button class="debt-btn edit" onclick="event.stopPropagation();editBalance(\''+x.id+'\')">Edit</button></div>')+last+'</div>';
  }).join('');
  s.innerHTML='<option value="">Select debt</option>'+debts.filter(d=>!d.paid).map(x=>'<option value="'+x.id+'">'+x.n+' (Â£'+x.b+')</option>').join('');
}

function showDebtOpts(id){
  let d=debts.find(x=>x.id===id);
  if(!d||d.paid)return;
  let m='Pay towards '+d.n+':\n\nBalance: Â£'+d.b+'\nMin: Â£'+d.min+'\n\n1. Pay Minimum\n2. Custom Amount\n3. Edit Balance\n\nCancel to close';
  let r=prompt(m);
  if(r==='1')payMin(id);
  else if(r==='2')payCustom(id);
  else if(r==='3')editBalance(id);
}

function payMin(id){
  let d=debts.find(x=>x.id===id);
  if(!d||d.paid)return;
  let a=d.b<d.min?d.b:d.min;
  addPayment(d,a);
}

function payCustom(id){
  let d=debts.find(x=>x.id===id);
  if(!d||d.paid)return;
  let a=prompt('Amount to pay '+d.n+'?',d.min);
  if(a&&parseFloat(a)>0){
    a=Math.min(parseFloat(a),d.b);
    addPayment(d,a);
  }
}

function editBalance(id){
  let d=debts.find(x=>x.id===id);
  if(!d)return;
  let b=prompt('New balance for '+d.n+'?',d.b);
  if(b&&parseFloat(b)>=0){
    d.b=parseFloat(b);
    if(d.b<0.01){d.b=0;d.paid=true;d.h=[];}
    saveAll();
    renderDebts();
  }
}

function addPayment(d,amount){
  if(amount>d.b)amount=d.b;
  d.b-=amount;
  d.h.push({a:amount,d:new Date().toLocaleDateString('en-GB'),t:Date.now()});
  if(d.b<0.01){d.b=0;d.paid=true;}
  history.unshift({n:d.n,a:amount,d:new Date().toLocaleDateString('en-GB'),t:Date.now()});
  saveAll();
  renderDebts();
  renderHistory();
  toast(amount>0?'Paid Â£'+amount:'Balance updated');
}

function undoPayment(idx){
  let h=history[idx];
  if(!h)return;
  let amount=parseFloat(h.a);
  if(!confirm('Undo payment of Â£'+amount.toFixed(2)+' to '+h.n+'?'))return;
  let d=debts.find(x=>x.n.trim()===h.n.trim());
  if(d){
    d.b=d.b+amount;
    d.paid=false;
    d.h=d.h.filter(y=>y.t!==h.t);
    d.b=Math.round(d.b*100)/100;
  }
  history.splice(idx,1);
  saveAll();
  renderDebts();
  renderHistory();
  toast('Payment undone - Â£'+amount.toFixed(2)+' restored');
}

function quickPay(){
  let a=parseFloat(document.getElementById('payAmt').value);
  let id=document.getElementById('payDebt').value;
  if(!id||!a||a<=0)return alert('Select debt and amount');
  let d=debts.find(x=>x.id===id);
  if(!d||d.paid)return;
  addPayment(d,a);
  document.getElementById('payAmt').value='';
}

function renderHistory(){
  let h=document.getElementById('histList');
  if(history.length===0){
    h.innerHTML='No payments';
    return;
  }
  h.innerHTML=history.map((x,i)=>
    '<div class="hist-item"><div class="hist-info"><div>'+x.n+'</div><div class="hist-date">'+x.d+'</div></div><div style="display:flex;align-items:center;gap:10px"><span class="hist-amt">-Â£'+x.a+'</span><button class="tag orange" onclick="undoPayment('+i+')" style="cursor:pointer">Undo</button></div></div>'
  ).join('');
}

function clearHist(){
  if(history.length===0)return;
  if(confirm('Clear all history?')){
    history=[];
    saveAll();
    renderHistory();
  }
}

function exportData(){
  let data={bills:bills,debts:debts,history:history,exported:new Date().toISOString()};
  let blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  let url=URL.createObjectURL(blob);
  let a=document.createElement('a');
  a.href=url;
  a.download='life-os-backup-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  toast('Backup downloaded!');
}

function importData(){
  let input=document.createElement('input');
  input.type='file';
  input.accept='.json';
  input.onchange=e=>{
    let file=e.target.files[0];
    let reader=new FileReader();
    reader.onload=ev=>{
      try{
        let data=JSON.parse(ev.target.result);
        if(data.bills)bills=data.bills;
        if(data.debts)debts=data.debts;
        if(data.history)history=data.history;
        saveAll();
        renderBills();
        renderDebts();
        renderHistory();
        toast('Data imported successfully!');
      }catch(err){
        alert('Invalid backup file');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function toast(msg){
  let t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:140px;left:50%;transform:translateX(-50%);padding:12px 24px;background:var(--green);color:#fff;border-radius:10px;font-size:14px;z-index:9999';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}


// Todoist Integration
function saveTodoistToken(){
  let token=document.getElementById('todoist-token').value.trim();
  localStorage.setItem('todoistToken',token);
  if(token)loadTodoist();
}

async function loadTodoist(){
  let token=localStorage.getItem('todoistToken');
  if(!token){
    document.getElementById('todoist-tasks').innerHTML='<span style="color:var(--orange)">Add API token in Settings first</span>';
    return;
  }
  document.getElementById('todoist-tasks').innerHTML='Loading...';
  
  try{
    let resp=await fetch('https://api.todoist.com/rest/v2/tasks',{
      headers:{'Authorization':'Bearer '+token}
    });
    if(!resp.ok)throw new Error('API error');
    let tasks=await resp.json();
    
    // Filter for overdue + due today (NOT tasks with no due date)
    let today=new Date().toISOString().split('T')[0];
    let overdue=tasks.filter(t=>t.due&&t.due.date<today);
    let dueToday=tasks.filter(t=>t.due&&t.due.date===today);
    let allDue=[...overdue,...dueToday];
    
    if(overdue.length>0){
      document.getElementById('todoist-tasks').innerHTML=overdue.map(t=>`
        <div class="todoist-task" onclick="completeTodoistTask('${t.id}')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:10px;margin-bottom:8px;cursor:pointer;border:1px solid var(--red)">
          <div style="width:24px;height:24px;border-radius:6px;border:2px solid var(--red);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--red)">âš ï¸</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:500;color:var(--red)">${t.content}</div>
            <div style="font-size:11px;color:var(--text-muted)">Overdue: ${t.due.date}</div>
          </div>
        </div>
      `).join('');
    }
    if(dueToday.length===0 && overdue.length===0){
      document.getElementById('todoist-tasks').innerHTML='<span style="color:var(--green)">ğŸ‰ All caught up! Nothing overdue or due today.</span>';
    }else if(dueToday.length>0){
      let html=document.getElementById('todoist-tasks').innerHTML;
      if(overdue.length>0)html+='<div style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">DUE TODAY</div>';
      document.getElementById('todoist-tasks').innerHTML=html+dueToday.map(t=>`
        <div class="todoist-task" onclick="completeTodoistTask('${t.id}')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:8px;cursor:pointer">
          <div style="width:24px;height:24px;border-radius:6px;border:2px solid var(--purple);display:flex;align-items:center;justify-content:center;flex-shrink:0">â˜</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:500">${t.content}</div>
            <div style="font-size:11px;color:var(--text-muted)">${t.priority>1?'ğŸ”´ğŸŸ ğŸŸ¡'.slice(0,t.priority-1)+' ':''}Due today</div>
          </div>
        </div>
      `).join('');
    }
        <div class="todoist-task" onclick="completeTodoistTask('${t.id}')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:8px;cursor:pointer">
          <div style="width:24px;height:24px;border-radius:6px;border:2px solid var(--purple);display:flex;align-items:center;justify-content:center;flex-shrink:0">â˜</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:500">${t.content}</div>
            <div style="font-size:11px;color:var(--text-muted)">${t.project_id?'Project #'+t.project_id:''}${t.priority>1?' â€¢ '+'ğŸ”´ğŸŸ ğŸŸ¡'.slice(0,t.priority-1):''}</div>
          </div>
        </div>
      `).join('');
    }
    let total=overdue.length+dueToday.length;
    document.getElementById('todoist-count').textContent=total+' tasks';
    document.getElementById('todoist-count').style.background=overdue.length>0?'var(--red)':'var(--purple)';
  }catch(e){
    document.getElementById('todoist-tasks').innerHTML='<span style="color:var(--red)">Error loading tasks. Check API token.</span>';
  }
}

async function completeTodoistTask(taskId){
  let token=localStorage.getItem('todoistToken');
  if(!token)return;
  
  try{
    let resp=await fetch('https://api.todoist.com/rest/v2/tasks/'+taskId+'/close',{
      method:'POST',
      headers:{'Authorization':'Bearer '+token}
    });
    if(resp.ok){
      loadTodoist();
      toast('Task completed!');
    }else{
      alert('Failed to complete task');
    }
  }catch(e){
    alert('Error: '+e.message);
  }
}

function updateClocks(){
  let n=new Date(),t=n.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}),d=n.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'});
  ['clock','clockM','clockH','clockT','clockS'].forEach(x=>{let e=document.getElementById(x);if(e)e.textContent=t});
  ['dayInfo','dayInfoM','dayInfoH','dayInfoT','dayInfoS'].forEach(x=>{let e=document.getElementById(x);if(e)e.textContent=d});
  let dn=n.getDate(),td=(n.getFullYear()%4===0)?366:365;
  document.getElementById('yearPct').textContent=Math.round((dn/td)*100)+'%';
  document.getElementById('daysTo').textContent=Math.ceil((new Date('2026-03-02')-n)/(1000*60*60*24));
}

checkDayReset();
loadAll();
renderHabits();
renderBills();
renderDebts();
renderHistory();
setInterval(updateClocks,1000);
updateClocks();
</script>
</body>
</html>
